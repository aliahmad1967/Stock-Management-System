<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            direction: rtl;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        /* Section 1 Styles */
        .section-1 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .search-area {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            flex: 1;
            position: relative;
        }

        .input-field input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .suggestions {
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .suggestion-item.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .suggestion-item img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 4px;
        }

        .items-grid {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            align-content: flex-start;
        }

        .category-card, .item-card, .folder-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            border: 2px solid transparent;
        }

        .category-card:hover, .item-card:hover, .folder-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .category-card {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .folder-card {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .item-card {
            border: 1px solid #eee;
        }

        .item-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-price {
            color: var(--success-color);
            font-weight: bold;
        }

        .back-button {
            display: none;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: var(--warning-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .back-button:hover {
            background-color: #e67e22;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: 500;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #777;
        }

        /* Section 2 Styles */
        .section-2 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .bill-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }

        .bill-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .bill-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bill-table th, .bill-table td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .bill-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .bill-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .bill-table input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .remove-item {
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Section 3 Styles */
        .section-3 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .totals-area {
            padding: 20px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .total-row .paid-input {
            width: 160px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            text-align: right;
            direction: ltr;
        }

        .total-row .paid-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .total-row.total {
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 1px solid #ddd;
            margin-top: 10px;
            padding-top: 15px;
        }

        .numpad {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .numpad button {
            padding: 15px;
            border: none;
            border-radius: var(--border-radius);
            background-color: #f0f0f0;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .numpad button:hover {
            background-color: #e0e0e0;
        }

        .numpad .action {
            background-color: var(--secondary-color);
            color: white;
        }

        .numpad .action:hover {
            background-color: #2980b9;
        }

        .checkout-btn {
            padding: 20px;
        }

        .checkout-btn button {
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .checkout-btn button:hover {
            background-color: #27ae60;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-bill, .print-bill * {
                visibility: visible;
            }
            .print-bill {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        .print-bill {
            display: none;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .bill-header-print {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .bill-items-print {
            margin-bottom: 20px;
        }

        .bill-totals-print {
            border-top: 2px solid #000;
            padding-top: 10px;
        }

        .notification {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .section-1, .section-2, .section-3 {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Section 1: Item Selection -->
        <section class="section-1">
            <div class="search-area">
                <div class="input-group">
                    <div class="input-field">
                        <input type="text" id="barcodeInput" placeholder="أدخل الباركود ثم اضغط Enter">
                    </div>
                    <div class="input-field">
                        <input type="text" id="nameSearchInput" placeholder="ابحث بالاسم">
                        <div class="suggestions" id="suggestionsList"></div>
                    </div>
                </div>
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" data-level="0">الرئيسية</span>
                </div>
                <button class="back-button" id="backToCategories">
                    <i class="fas fa-arrow-right"></i> العودة للفئات
                </button>
            </div>
            <div class="items-grid" id="itemsGrid">
                <!-- Categories, folders and items will be populated by JavaScript -->
            </div>
        </section>

        <!-- Section 2: Bill -->
        <section class="section-2">
            <div class="bill-header">
                <h2>فاتورة البيع</h2>
            </div>
            <div class="bill-items">
                <table class="bill-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>السعر</th>
                            <th>الكمية</th>
                            <th>المجموع</th>
                            <th>حذف</th>
                        </tr>
                    </thead>
                    <tbody id="billItemsBody">
                        <!-- Bill items will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 3: Totals and Payment -->
        <section class="section-3">
            <div class="totals-area">
                <div class="total-row">
                    <span>المجموع الفرعي:</span>
                    <span id="subtotalValue">0.00 د.ع</span>
                </div>
                <div class="total-row">
                    <span>خصم الفاتورة:</span>
                    <span id="discountValue">0.00 د.ع</span>
                </div>
                <div class="total-row total">
                    <span>المجموع النهائي:</span>
                    <span id="totalValue">0.00 د.ع</span>
                </div>
                <div class="total-row">
                    <span>المبلغ المدفوع:</span>
                    <input type="number" id="paidInput" class="paid-input" value="0.00" step="0.01" min="0" dir="ltr">
                </div>
                <div class="total-row total">
                    <span>الباقي:</span>
                    <span id="balanceValue">0.00 د.ع</span>
                </div>
            </div>
            <div class="numpad">
                <button>7</button>
                <button>8</button>
                <button>9</button>
                <button>4</button>
                <button>5</button>
                <button>6</button>
                <button>1</button>
                <button>2</button>
                <button>3</button>
                <button>0</button>
                <button>.</button>
                <button class="action">←</button>
            </div>
            <div class="checkout-btn">
                <button id="checkoutBtn">إتمام البيع وطباعة الفاتورة</button>
            </div>
        </section>
    </div>

    <!-- Print Bill Template -->
    <div class="print-bill" id="printBill">
        <div class="bill-header-print">
            <h1>فاتورة بيع</h1>
            <p>نظام إدارة المخزون</p>
            <p id="billDate">التاريخ: </p>
            <p id="billNumber">رقم الفاتورة: </p>
        </div>
        <div class="bill-items-print">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border-bottom: 1px solid #000; padding: 8px;">الاسم</th>
                        <th style="border-bottom: 1px solid #000; padding: 8px;">السعر</th>
                        <th style="border-bottom: 1px solid #000; padding: 8px;">الكمية</th>
                        <th style="border-bottom: 1px solid #000; padding: 8px;">المجموع</th>
                    </tr>
                </thead>
                <tbody id="printBillItems">
                    <!-- Bill items for printing -->
                </tbody>
            </table>
        </div>
        <div class="bill-totals-print">
            <p><strong>المجموع الفرعي: </strong><span id="printSubtotal">0.00 د.ع</span></p>
            <p><strong>خصم الفاتورة: </strong><span id="printDiscount">0.00 د.ع</span></p>
            <p><strong>المجموع النهائي: </strong><span id="printTotal">0.00 د.ع</span></p>
            <p><strong>المبلغ المدفوع: </strong><span id="printPaid">0.00 د.ع</span></p>
            <p><strong>الباقي: </strong><span id="printBalance">0.00 د.ع</span></p>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <p>شكراً لتعاملكم معنا</p>
        </div>
    </div>

    <script>
        // Database setup (مشترك مع بقية الصفحات)
        const DB_NAME = 'InventorySystem';
        const DB_VERSION = 2;
        const STORE_NAMES = {
            PRODUCTS: 'products',
            BILLS: 'bills',
            CATEGORIES: 'categories',
            SETTINGS: 'settings',
            BACKUPS: 'backups'
        };
        const STORE_NAME = STORE_NAMES.PRODUCTS;
        const BILLS_STORE_NAME = STORE_NAMES.BILLS;

        let db;
        let currentCategory = null;
        let currentFolder = null;
        let navigationStack = [];
        let billItems = [];
        let billNumber = 1;
        let subtotal = 0;
        let discount = 0;
        let total = 0;
        let paidAmount = 0;
        let balance = 0;
        let currentInputField = null;
        let currentInputValue = '';

        // Category structure with folders
        const categoryStructure = {
            'إلكترونيات': {
                type: 'folder',
                subcategories: {
                    'حواسيب ومعدات': {
                        type: 'folder',
                        subcategories: {
                            'لابتوبات': 'لابتوبات',
                            'حواسيب مكتبية': 'حواسيب مكتبية',
                            'طابعات': 'طابعات'
                        }
                    },
                    'هواتف وأجهزة لوحية': {
                        type: 'folder',
                        subcategories: {
                            'هواتف ذكية': 'هواتف ذكية',
                            'أجهزة لوحية': 'أجهزة لوحية',
                            'إكسسوارات الهواتف': 'إكسسوارات الهواتف'
                        }
                    },
                    'إلكترونيات منزلية': {
                        type: 'folder',
                        subcategories: {
                            'تلفزيونات': 'تلفزيونات',
                            'أنظمة صوت': 'أنظمة صوت',
                            'أجهزة منزلية': 'أجهزة منزلية'
                        }
                    }
                }
            },
            'أثاث': {
                type: 'folder',
                subcategories: {
                    'أثاث مكتبي': 'أثاث مكتبي',
                    'أثاث منزلي': 'أثاث منزلي',
                    'أثاث حدائق': 'أثاث حدائق'
                }
            },
            'ملابس': {
                type: 'folder',
                subcategories: {
                    'ملابس رجالية': 'ملابس رجالية',
                    'ملابس نسائية': 'ملابس نسائية',
                    'ملابس أطفال': 'ملابس أطفال'
                }
            },
            'إكسسوارات': 'إكسسوارات',
            'معدات مكتبية': 'معدات مكتبية',
            'أدوات كهربائية': 'أدوات كهربائية'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDB();
            setupEventListeners();
            loadMainCategories();
        });

        // Initialize IndexedDB
        function initializeDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = function(event) {
                console.error('فشل في فتح قاعدة البيانات:', event.target.error);
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                
                // Load existing bill number or initialize
                const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(BILLS_STORE_NAME);
                const countRequest = objectStore.count();
                
                countRequest.onsuccess = function() {
                    billNumber = countRequest.result + 1;
                };
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;

                if (!db.objectStoreNames.contains(STORE_NAMES.PRODUCTS)) {
                    const store = db.createObjectStore(STORE_NAMES.PRODUCTS, {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    store.createIndex('name', 'name', { unique: false });
                    store.createIndex('barcode', 'barcode', { unique: true });
                    store.createIndex('category', 'category', { unique: false });
                }

                if (!db.objectStoreNames.contains(STORE_NAMES.BILLS)) {
                    const store = db.createObjectStore(STORE_NAMES.BILLS, {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    store.createIndex('date', 'date', { unique: false });
                    store.createIndex('number', 'number', { unique: true });
                }

                if (!db.objectStoreNames.contains(STORE_NAMES.CATEGORIES)) {
                    const store = db.createObjectStore(STORE_NAMES.CATEGORIES, {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    store.createIndex('name', 'name', { unique: true });
                }

                if (!db.objectStoreNames.contains(STORE_NAMES.SETTINGS)) {
                    db.createObjectStore(STORE_NAMES.SETTINGS, { keyPath: 'key' });
                }

                if (!db.objectStoreNames.contains(STORE_NAMES.BACKUPS)) {
                    const store = db.createObjectStore(STORE_NAMES.BACKUPS, {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    store.createIndex('date', 'date', { unique: false });
                }
            };
        }

        // Set up event listeners
        function setupEventListeners() {
            // Barcode input
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addItemByBarcode(this.value);
                    this.value = '';
                }
            });
            
            // Name search input
            const nameSearchInput = document.getElementById('nameSearchInput');
            nameSearchInput.addEventListener('input', function() {
                searchItemsByName(this.value);
            });
            
            nameSearchInput.addEventListener('keydown', function(e) {
                handleSuggestionNavigation(e);
            });
            
            // Back to categories button
            document.getElementById('backToCategories').addEventListener('click', function() {
                navigateBack();
            });
            
            // Checkout button
            document.getElementById('checkoutBtn').addEventListener('click', checkoutBill);

            // Paid amount input
            const paidInput = document.getElementById('paidInput');
            paidInput.addEventListener('focus', function() {
                currentInputField = this;
                currentInputValue = this.value;
            });
            paidInput.addEventListener('input', function() {
                currentInputField = this;
                currentInputValue = this.value;
                updatePaidAmount(this.value);
            });
            paidInput.addEventListener('blur', function() {
                currentInputField = null;
                currentInputValue = '';
            });
            
            // Numpad buttons
            document.querySelectorAll('.numpad button').forEach(button => {
                button.addEventListener('click', function() {
                    handleNumpadInput(this.textContent);
                });
            });
            
            // Set initial focus
            document.getElementById('barcodeInput').focus();
            
            // Add click handlers for editable fields
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('price-input') || 
                    e.target.classList.contains('quantity-input')) {
                    currentInputField = e.target;
                    currentInputValue = e.target.value;
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Number keys (0-9) and decimal point
                if ((e.key >= '0' && e.key <= '9') || e.key === '.') {
                    if (document.activeElement !== document.getElementById('barcodeInput') && 
                        document.activeElement !== document.getElementById('nameSearchInput')) {
                        handleNumpadInput(e.key);
                    }
                }
                
                // Backspace
                if (e.key === 'Backspace') {
                    if (document.activeElement !== document.getElementById('barcodeInput') && 
                        document.activeElement !== document.getElementById('nameSearchInput')) {
                        handleNumpadInput('←');
                    }
                }
                
                // Escape to clear current input
                if (e.key === 'Escape') {
                    currentInputField = null;
                    currentInputValue = '';
                    document.getElementById('barcodeInput').focus();
                }
                
                // F2 to apply 10% discount
                if (e.key === 'F2') {
                    applyDiscount(subtotal * 0.1);
                }
                
                // F3 to clear discount
                if (e.key === 'F3') {
                    applyDiscount(0);
                }
            });
        }

        // Load main categories
        function loadMainCategories() {
            navigationStack = [];
            updateBreadcrumb();
            displayCategories(categoryStructure);
        }

        // Display categories/folders in the grid
        function displayCategories(structure) {
            const itemsGrid = document.getElementById('itemsGrid');
            itemsGrid.innerHTML = '';
            
            Object.keys(structure).forEach(key => {
                const item = structure[key];
                let card;
                
                if (typeof item === 'object' && item.type === 'folder') {
                    // Display folder
                    card = document.createElement('div');
                    card.className = 'folder-card';
                    card.innerHTML = `
                        <i class="fas fa-folder" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>${key}</div>
                    `;
                    
                    card.addEventListener('click', function() {
                        navigateToFolder(key, item.subcategories);
                    });
                } else {
                    // Display category
                    card = document.createElement('div');
                    card.className = 'category-card';
                    card.innerHTML = `
                        <i class="fas fa-tags" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>${key}</div>
                    `;
                    
                    card.addEventListener('click', function() {
                        loadItemsByCategory(key);
                    });
                }
                
                itemsGrid.appendChild(card);
            });
        }

        // Navigate to folder
        function navigateToFolder(folderName, folderContent) {
            navigationStack.push({
                name: folderName,
                content: folderContent
            });
            
            updateBreadcrumb();
            displayCategories(folderContent);
            document.getElementById('backToCategories').style.display = 'block';
        }

        // Navigate back in folder structure
        function navigateBack() {
            if (navigationStack.length > 0) {
                navigationStack.pop();
            }
            
            if (navigationStack.length === 0) {
                loadMainCategories();
                document.getElementById('backToCategories').style.display = 'none';
            } else {
                const currentLevel = navigationStack[navigationStack.length - 1];
                updateBreadcrumb();
                displayCategories(currentLevel.content);
            }
        }

        // Update breadcrumb navigation
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            
            // Add home link
            const homeItem = document.createElement('span');
            homeItem.className = 'breadcrumb-item';
            homeItem.textContent = 'الرئيسية';
            homeItem.addEventListener('click', loadMainCategories);
            breadcrumb.appendChild(homeItem);
            
            // Add folder links
            navigationStack.forEach((level, index) => {
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator';
                separator.textContent = ' / ';
                breadcrumb.appendChild(separator);
                
                const breadcrumbItem = document.createElement('span');
                breadcrumbItem.className = 'breadcrumb-item';
                breadcrumbItem.textContent = level.name;
                breadcrumbItem.addEventListener('click', function() {
                    // Navigate to this level
                    navigationStack = navigationStack.slice(0, index + 1);
                    if (index === navigationStack.length - 1) {
                        updateBreadcrumb();
                        displayCategories(level.content);
                    }
                });
                breadcrumb.appendChild(breadcrumbItem);
            });
        }

        // Load items by category
        function loadItemsByCategory(category) {
            currentCategory = category;
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const index = objectStore.index('category');
            const request = index.getAll(category);
            
            request.onsuccess = function(event) {
                const items = event.target.result;
                displayItems(items);
            };
        }

        // Display items in the grid
        function displayItems(items) {
            const itemsGrid = document.getElementById('itemsGrid');
            itemsGrid.innerHTML = '';
            
            if (items.length === 0) {
                itemsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #777;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>لا توجد منتجات في هذه الفئة</p>
                    </div>
                `;
                return;
            }
            
            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                
                if (item.image) {
                    itemCard.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${item.price ? item.price.toFixed(2) : '0.00'} د.ع</div>
                    `;
                } else {
                    itemCard.innerHTML = `
                        <div class="item-name" style="font-size: 1.2rem; margin-bottom: 10px;">${item.name}</div>
                        <div class="item-price">${item.price ? item.price.toFixed(2) : '0.00'} د.ع</div>
                    `;
                }
                
                itemCard.addEventListener('click', function() {
                    addItemToBill(item);
                });
                
                itemsGrid.appendChild(itemCard);
            });
        }

        // Search items by name and display suggestions
        function searchItemsByName(searchTerm) {
            if (searchTerm.length < 2) {
                document.getElementById('suggestionsList').style.display = 'none';
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();
            
            request.onsuccess = function(event) {
                const items = event.target.result;
                const filteredItems = items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                displaySuggestions(filteredItems);
            };
        }

        // Display search suggestions
        function displaySuggestions(items) {
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            
            if (items.length === 0) {
                suggestionsList.style.display = 'none';
                return;
            }
            
            items.forEach(item => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                
                if (item.image) {
                    suggestionItem.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">
                        <div>${item.name} - ${item.price ? item.price.toFixed(2) : '0.00'} د.ع</div>
                    `;
                } else {
                    suggestionItem.innerHTML = `
                        <div>${item.name} - ${item.price ? item.price.toFixed(2) : '0.00'} د.ع</div>
                    `;
                }
                
                suggestionItem.addEventListener('click', function() {
                    addItemToBill(item);
                    document.getElementById('nameSearchInput').value = '';
                    suggestionsList.style.display = 'none';
                });
                
                suggestionsList.appendChild(suggestionItem);
            });
            
            suggestionsList.style.display = 'block';
        }

        // Handle keyboard navigation in suggestions
        function handleSuggestionNavigation(e) {
            const suggestions = document.querySelectorAll('.suggestion-item');
            let activeIndex = -1;
            
            suggestions.forEach((suggestion, index) => {
                if (suggestion.classList.contains('active')) {
                    activeIndex = index;
                    suggestion.classList.remove('active');
                }
            });
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
            } else if (e.key === 'Enter' && activeIndex >= 0) {
                e.preventDefault();
                suggestions[activeIndex].click();
                return;
            }
            
            if (activeIndex >= 0) {
                suggestions[activeIndex].classList.add('active');
            }
        }

        // Add item to bill by barcode
        function addItemByBarcode(barcode) {
            if (!barcode) return;
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const index = objectStore.index('barcode');
            const request = index.get(barcode);
            
            request.onsuccess = function(event) {
                const item = event.target.result;
                if (item) {
                    addItemToBill(item);
                } else {
                    alert('لم يتم العثور على منتج بهذا الباركود');
                }
            };
        }

        // Add item to bill
        function addItemToBill(item) {
            // Check if item already exists in bill
            const existingItemIndex = billItems.findIndex(billItem => billItem.id === item.id);
            
            if (existingItemIndex >= 0) {
                // Increase quantity of existing item
                billItems[existingItemIndex].quantity += 1;
            } else {
                // Add new item to bill
                billItems.push({
                    id: item.id,
                    name: item.name,
                    price: item.price || 0,
                    quantity: 1,
                    total: item.price || 0
                });
            }
            
            updateBillDisplay();
            focusOnRecentItem();
        }

        // Update bill display
        function updateBillDisplay() {
            const billItemsBody = document.getElementById('billItemsBody');
            billItemsBody.innerHTML = '';
            
            subtotal = 0;
            
            billItems.forEach((item, index) => {
                item.total = item.price * item.quantity;
                subtotal += item.total;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td><input type="number" class="price-input" data-index="${index}" value="${item.price.toFixed(2)}" step="0.01"></td>
                    <td><input type="number" class="quantity-input" data-index="${index}" value="${item.quantity}" min="1"></td>
                    <td>${item.total.toFixed(2)} د.ع</td>
                    <td><i class="fas fa-times remove-item" data-index="${index}"></i></td>
                `;
                
                billItemsBody.appendChild(row);
            });
            
            // Add event listeners to inputs
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    billItems[index].price = parseFloat(this.value) || 0;
                    updateBillDisplay();
                });
                
                input.addEventListener('focus', function() {
                    currentInputField = this;
                    currentInputValue = this.value;
                });
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    billItems[index].quantity = parseInt(this.value) || 1;
                    updateBillDisplay();
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('barcodeInput').focus();
                        currentInputField = null;
                        currentInputValue = '';
                    }
                });
                
                input.addEventListener('focus', function() {
                    currentInputField = this;
                    currentInputValue = this.value;
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(icon => {
                icon.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    billItems.splice(index, 1);
                    updateBillDisplay();
                });
            });
            
            // Update totals
            total = subtotal - discount;
            balance = total - paidAmount;
            
            document.getElementById('subtotalValue').textContent = subtotal.toFixed(2) + ' د.ع';
            document.getElementById('totalValue').textContent = total.toFixed(2) + ' د.ع';
            document.getElementById('balanceValue').textContent = balance.toFixed(2) + ' د.ع';
            
            // Update print values
            document.getElementById('printSubtotal').textContent = subtotal.toFixed(2) + ' د.ع';
            document.getElementById('printTotal').textContent = total.toFixed(2) + ' د.ع';
        }

        // Focus on the most recently added item's quantity field
        function focusOnRecentItem() {
            if (billItems.length > 0) {
                const recentIndex = billItems.length - 1;
                const quantityInputs = document.querySelectorAll('.quantity-input');
                if (quantityInputs.length > 0) {
                    quantityInputs[recentIndex].focus();
                    quantityInputs[recentIndex].select();
                }
            }
        }

        // Handle numpad input
        function handleNumpadInput(value) {
            if (value === '.' && currentInputValue.includes('.')) {
                return; // Prevent multiple decimal points
            }
            
            if (value === '←') {
                // Backspace functionality
                currentInputValue = currentInputValue.slice(0, -1);
            } else {
                // Append the input value
                currentInputValue += value;
            }
            
            // Update the current input field if one is focused
            if (currentInputField) {
                currentInputField.value = currentInputValue;
                
                // Trigger change event to update calculations
                const event = new Event('change', { bubbles: true });
                currentInputField.dispatchEvent(event);
            } else {
                // If no input field is focused, update paid amount
                updatePaidAmount(currentInputValue);
            }
        }

        // Update paid amount from numpad input
        function updatePaidAmount(amount) {
            paidAmount = parseFloat(amount) || 0;
            balance = total - paidAmount;
            
            const paidInput = document.getElementById('paidInput');
            paidInput.value = paidAmount.toFixed(2);
            document.getElementById('balanceValue').textContent = balance.toFixed(2) + ' د.ع';
            
            // Update print values as well
            document.getElementById('printPaid').textContent = paidAmount.toFixed(2) + ' د.ع';
            document.getElementById('printBalance').textContent = balance.toFixed(2) + ' د.ع';
        }

        // Apply discount to bill
        function applyDiscount(discountAmount) {
            discount = parseFloat(discountAmount) || 0;
            
            // Ensure discount doesn't exceed subtotal
            if (discount > subtotal) {
                discount = subtotal;
            }
            
            total = subtotal - discount;
            balance = total - paidAmount;
            
            document.getElementById('discountValue').textContent = discount.toFixed(2) + ' د.ع';
            document.getElementById('totalValue').textContent = total.toFixed(2) + ' د.ع';
            document.getElementById('balanceValue').textContent = balance.toFixed(2) + ' د.ع';
            
            // Update print values
            document.getElementById('printDiscount').textContent = discount.toFixed(2) + ' د.ع';
            document.getElementById('printTotal').textContent = total.toFixed(2) + ' د.ع';
            document.getElementById('printBalance').textContent = balance.toFixed(2) + ' د.ع';
        }

        // Checkout bill
        function checkoutBill() {
            if (billItems.length === 0) {
                alert('لا توجد عناصر في الفاتورة');
                return;
            }
            
            if (paidAmount < total) {
                if (!confirm('المبلغ المدفوع أقل من المجموع النهائي. هل تريد المتابعة؟')) {
                    return;
                }
            }
            
            // Save bill to database
            const bill = {
                number: billNumber,
                date: new Date(),
                items: [...billItems], // Create a copy of the items
                subtotal: subtotal,
                discount: discount,
                total: total,
                paid: paidAmount,
                balance: balance
            };
            
            const transaction = db.transaction([BILLS_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(BILLS_STORE_NAME);
            const request = objectStore.add(bill);
            
            request.onsuccess = function() {
                // Prepare print bill
                preparePrintBill(bill);
                
                // Print bill
                setTimeout(() => {
                    window.print();
                    
                    // Reset for next bill after print dialog closes
                    setTimeout(() => {
                        resetBill();
                    }, 500);
                }, 500);
            };
            
            request.onerror = function(event) {
                console.error('فشل في حفظ الفاتورة:', event.target.error);
                alert('حدث خطأ أثناء حفظ الفاتورة');
            };
        }

        // Prepare print bill
        function preparePrintBill(bill) {
            const printBill = document.getElementById('printBill');
            const printBillItems = document.getElementById('printBillItems');
            
            // Set bill details
            document.getElementById('billDate').textContent = 'التاريخ: ' + new Date(bill.date).toLocaleString('ar-SA');
            document.getElementById('billNumber').textContent = 'رقم الفاتورة: ' + bill.number;
            
            // Add bill items
            printBillItems.innerHTML = '';
            bill.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.price.toFixed(2)} د.ع</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.quantity}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.total.toFixed(2)} د.ع</td>
                `;
                printBillItems.appendChild(row);
            });
            
            // Set totals
            document.getElementById('printSubtotal').textContent = bill.subtotal.toFixed(2) + ' د.ع';
            document.getElementById('printDiscount').textContent = bill.discount.toFixed(2) + ' د.ع';
            document.getElementById('printTotal').textContent = bill.total.toFixed(2) + ' د.ع';
            document.getElementById('printPaid').textContent = bill.paid.toFixed(2) + ' د.ع';
            document.getElementById('printBalance').textContent = bill.balance.toFixed(2) + ' د.ع';
            
            // Show print bill
            printBill.style.display = 'block';
        }

        // Reset bill for next sale
        function resetBill() {
            billItems = [];
            subtotal = 0;
            discount = 0;
            total = 0;
            paidAmount = 0;
            balance = 0;
            currentInputField = null;
            currentInputValue = '';
            
            updateBillDisplay();
            document.getElementById('paidInput').value = '0.00';
            document.getElementById('barcodeInput').focus();
            
            // Hide print bill
            document.getElementById('printBill').style.display = 'none';
            
            // Show success message
            showNotification('تم إتمام البيع بنجاح وجاهز للبيع التالي', 'success');
        }

        // Show notification
        function showNotification(message, type) {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });
            
            // Create notification element
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                padding: 15px 20px;
                border-radius: var(--border-radius);
                color: white;
                font-weight: 600;
                z-index: 1001;
                box-shadow: var(--box-shadow);
                transition: var(--transition);
                background-color: ${type === 'success' ? 'var(--success-color)' : 'var(--accent-color)'};
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

    </script>
</body>
</html>